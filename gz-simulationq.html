<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id='gz-simulationq'>
  <template>
    <style>
      :host {
        display: block;
      }

      #config {
        max-width:40em;
        font-size:"0.8em"
      }

      #config > div{
        padding-top:1em;
      }

      #config > div > input{
        float:right;
      }
/*
      #gui > div > input{
        float:right;
      }
*/
      #gui  > div {
        padding-top:0.5em;
      }

      th{
        background-color:#ccc
      }

      span {
        @apply(--paper-font-body1);
      }
    </style>

    <iron-ajax
      id="ajaxItems"
      url=""
      handle-as="json"
      on-response="_hresponseItems"
      on-error="_herrorItems"
      headers="headers"
      debounce-duration="300"
      method='GET'>
    </iron-ajax>

    <iron-ajax
      id="ajaxCreate"
      url='[[url]]/simulations'
      handle-as='json'
      on-response='_hresponseCreate'
      on-error='_herrorCreate'
      debounce-duration="300"
      method='POST'
      >
    </iron-ajax>

    <iron-ajax
      id="ajaxUpdate"
      url=""
      handle-as="json"
      on-response="_hresponseUpdate"
      on-error="_herrorUpdate"
      debounce-duration="300">
    </iron-ajax>

    <iron-ajax
      id="ajaxDelete"
      url=""
      handle-as="json"
      on-response="_hresponseDelete"
      on-error="_herrorDelete"
      debounce-duration="300">
    </iron-ajax>

    <div id="config" hidden$=[[!config]]>


      <div>
        Sim server (url):<input id=url value="{{url::input}}" placeholder="Sim server (url)"></input>
      </div>
      <div>
        User (token):<input id=token value="{{token::input}}" placeholder="token"></input>
      </div>
     </div> <!-- /config -->

      <div id="gui" hidden$=[[!gui]]>

      <h2>Create a new simulation</h2>
      <div>
        <input id=cmdLine value="{{cmd::input}}" placeholder="cmd (command)"></input>
      </div>
      <div>
        <button on-tap="_tapCreate"  id="buttonCreate">Create</button>
      </div>


      <h2>Remove an existing simulation</h2>
      <div>
        <input id=simId value="{{simId::input}}" placeholder="Simulation ID"></input>
      </div>
      <div>
        <button on-tap="tapRemove" id="buttonRemove">Delete</button>
      </div>

      <h2>Edit an existing simulation</h2>
      <div>
        <input id=simId value="{{simId::input}}" placeholder="https://localhost:6060"></input>
      </div>
      <div>
        <input id=worldFile value="{{worldFile::input}}" placeholder="cmd line"></input>
      </div>
      <div>
        <button on-tap="tapEdit" id="buttonEdit">Update</button>
      </div>

      <h2>Simulation list </h2>
      <button on-tap="_tapGet" id="buttonGetSimulations">
        Get simulations
      </button>
      <div>
          <h2>Machines</h2>
          <template is="dom-repeat" items="{{items}}">
            <br>-------------------------
                 <div>id {{item.id}}</div>
                 <div>cmd {{item.data.cmd}}</div>
                 <div>perms {{item.permissions}}</div>

          </template>
      </div>
    </div><!-- /gui -->
  </template>

  <script>
    (function() {
      'use strict'

// this.fire('notification', {msg: "Request to launch machine has been sent.", type: "msg"})

      Polymer({
        is: 'gz-simulationq',

        // utility that prevents "//" in a url
        __buildUrl(server, route) {
          let url = server
          url += url.endsWith('/')?'':'/'
          url += route.startsWith('/')?route.substr(1):route
        },

        createSimulation: function(cmdLine) {
//        const data = {token: this.token, cmd: this.cmd}
          const data = {cmd: this.cmd}
          this.$.ajaxCreate.params = data
//          this.$.ajaxCreate.method = "POST"
//          this.$.ajaxCreate.url = __buildUrl(this.url, '/simulations')
          this.$.ajaxCreate.headers.authorization = this.token
          this.$.ajaxCreate.generateRequest()
        },

        _tapCreate: function() {
          this.createSimulation(this.cmd)
        },

        _hresponseCreate: function(req) {
          console.log('gz-simulationq _hresponseCreate')
          this.sim = this.$.ajaxCreate.lastResponse
        },

        _herrorCreate: function(err) {
          console.log('gz-simulationq _herrorCreate')
          this.fire('error', {msg:'error creating new simulation', error: err})
        },

        _hresponseUpdate: function(req) {
          console.log('gz-simulationq _hresponseUpdate')
          this.sim = this.$.ajaxUpdate.lastResponse
        },

        _herrorUpdate: function(err) {
          console.log('gz-simulationq _herrorUpdate')
          this.fire('error', {msg:'error updating simulation', error: err})
        },

        _hresponseDelete: function(req) {
          console.log('gz-simulationq _hresponseDelete')
          this.sim =  this.$.ajaxDelete.lastResponse
        },

        _herrorDelete: function(err) {
          console.log('gz-simulationq _herrorDelete')
          this.fire('error', {msg:'error deleting simulation', error: err})
        },

        _tapGet: function() {
          this.$.ajaxItems.url = this.__buildUrl(this.url, '/simulations')
          const data = { token: this.token}
          this.$.ajaxItems.params = data;
          this.$.ajaxItems.generateRequest()
        },

        _hresponseItems: function(req) {
          console.log('gz-simulationq _hresponseItems')
          let res = this.$.ajaxItems.lastResponse
          this.items = []
          if(res.result)
            this.items = res.result
          console.log(res)
        },

        _herrorItems: function(err) {
          console.log('gz-simulationq _herrorItems')
          this.fire('error', {msg:'error getting simulations', error: err})
        },

        properties: {

          items: {
            type: Array,
            notify: true
          },

          sim: {
            type: Object,
            notify: true,
            value: {}
          },

          title: {
            type: String,
            value: 'gz-simulationq title',
            notify: true
          },

          caption: {
            type: String,
            value: 'Manage imulations in a cloudsim-sim server.',
            notify: true
          },

          url: {
            type: String,
            value: 'https://localhost:4000',
            notify: true
          },

          token: {
            type: String,
            value: '',
            notify: true
          },

          cmd: {
            type: String,
            value: '',
            notify: true
          },

          gui: {
            type: Boolean,
            value: false
          },

          config: {
            type: Boolean,
            value: false
          }
        },

        attached: function() {
          console.log('gz-simulationq attached (id = ' + this.id + ')')
          this.items = [];
        }
      });
    })();
  </script>
</dom-module>
